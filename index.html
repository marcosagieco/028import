<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>游 Esquiva los Bloques (Seguro)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --bg: #0f172a; --text: #f1f5f9; --game-bg: #1e293b; --player: #22c55e; --enemy: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; display: flex; justify-content: center; overflow-x: hidden; touch-action: manipulation; }
        
        /* Contenedor principal */
        .container { max-width: 600px; width: 100%; padding: 20px; box-sizing: border-box; }

        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        h1 { margin: 0; font-size: 1.2em; }
        .user-info { font-size: 0.85em; color: #94a3b8; margin-right: 10px; }

        /* AREA DE JUEGO (CANVAS) */
        .game-wrapper { position: relative; width: 100%; text-align: center; }
        canvas { 
            background: var(--game-bg); 
            border-radius: 8px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            display: block; 
            margin: 0 auto;
            max-width: 100%;
            cursor: pointer;
        }

        /* UI SOBRE EL JUEGO */
        #startScreen, #gameOverScreen {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(15, 23, 42, 0.85);
            border-radius: 8px;
            z-index: 10;
        }
        
        .score-display { font-size: 3em; font-weight: bold; color: var(--primary); margin: 10px 0; text-shadow: 0 2px 10px rgba(59, 130, 246, 0.5); }
        .instructions { color: #cbd5e1; margin-bottom: 20px; font-size: 0.9em; padding: 0 20px; }

        /* Botones */
        button { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; font-size: 1em; cursor: pointer; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        button.logout { background: #334155; padding: 5px 12px; font-size: 0.8em; margin-left: 10px; }

        /* Controles M칩viles (Visuales) */
        .mobile-controls { display: flex; justify-content: space-between; margin-top: 10px; display: none; }
        .control-btn { background: #334155; width: 48%; padding: 20px; border-radius: 8px; font-size: 1.5em; opacity: 0.7; }
        @media (max-width: 768px) { .mobile-controls { display: flex; } }

        /* LEADERBOARD */
        .leaderboard-card { margin-top: 30px; background: #1e293b; padding: 20px; border-radius: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #334155; }
        th { color: #64748b; text-transform: uppercase; font-size: 0.8em; }
        .rank-1 { color: #fbbf24; } 
        .rank-2 { color: #94a3b8; }
        .rank-3 { color: #b45309; }

        /* PANTALLA DE LOGIN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .login-box { background: white; color: #1e293b; padding: 30px; border-radius: 12px; width: 85%; max-width: 320px; text-align: center; }
        .login-box input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- 1. LOGIN (Seguridad Obligatoria) -->
<div id="loginOverlay">
    <div class="login-box">
        <h2 style="margin-top:0;">游댏 Acceso Jugador</h2>
        <input type="email" id="emailInput" placeholder="Correo (ej: admin@vapes.com)">
        <input type="password" id="passInput" placeholder="Contrase침a">
        <button onclick="login()" style="width:100%;">Entrar</button>
        <p id="loginError" style="color: red; font-size: 0.8em; margin-bottom:0;"></p>
    </div>
</div>

<!-- 2. JUEGO -->
<div class="container">
    <header>
        <div>
            <h1>游 Esquiva-Bloques</h1>
            <span id="currentUserDisplay" class="user-info">Cargando...</span>
        </div>
        <button onclick="logout()" class="logout">Salir</button>
    </header>

    <div class="game-wrapper">
        <canvas id="gameCanvas" width="400" height="500"></canvas>
        
        <!-- Pantalla de Inicio -->
        <div id="startScreen">
            <i class="fas fa-rocket" style="font-size: 3em; color: var(--player); margin-bottom: 20px;"></i>
            <h2>쯃isto?</h2>
            <p class="instructions">Usa las flechas 拘勇 俱뫮잺 o toca los lados de la pantalla para moverte.</p>
            <button onclick="startGame()">Jugar Ahora</button>
        </div>

        <!-- Pantalla Game Over -->
        <div id="gameOverScreen" class="hidden">
            <h2 style="color: var(--enemy);">춰Choque! 游눤</h2>
            <p>Puntaje Final</p>
            <div class="score-display" id="finalScoreDisplay">0</div>
            <button onclick="startGame()">Intentar de nuevo</button>
        </div>
    </div>

    <!-- Controles t치ctiles expl칤citos -->
    <div class="mobile-controls">
        <button class="control-btn" ontouchstart="moveLeft()" onmousedown="moveLeft()">拘勇</button>
        <button class="control-btn" ontouchstart="moveRight()" onmousedown="moveRight()">俱뫮잺</button>
    </div>

    <!-- 3. RANKING (Nube en tiempo real) -->
    <div class="leaderboard-card">
        <h3 style="margin-top:0;">游끥 Mejores Puntajes (Global)</h3>
        <table>
            <thead><tr><th>#</th><th>Jugador</th><th>Puntos</th></tr></thead>
            <tbody id="leaderboardTable">
                <tr><td colspan="3">Cargando nube...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- LIBRER칈AS FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    // ==========================================
    // --- TU CONFIGURACI칍N DE FIREBASE AQU칈 ---
    // ==========================================
    const firebaseConfig = {
  apiKey: "AIzaSyDoMATZ1yjZ3Q0ZsaFSgprs7VegxMdTifs",
  authDomain: "gestion-de-ventas-vapes.firebaseapp.com",
  databaseURL: "https://gestion-de-ventas-vapes-default-rtdb.firebaseio.com",
  projectId: "gestion-de-ventas-vapes",
  storageBucket: "gestion-de-ventas-vapes.firebasestorage.app",
  messagingSenderId: "547834087144",
  appId: "1:547834087144:web:249116f7c21dba9815ab5d",
  measurementId: "G-4YQM8PBLSM"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // --- L칩gica de Login (Igual que antes) ---
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginOverlay').classList.add('hidden');
            // Usamos la parte del correo antes del @ como nombre de usuario
            document.getElementById('currentUserDisplay').textContent = "Jugador: " + user.email.split('@')[0];
        } else {
            document.getElementById('loginOverlay').classList.remove('hidden');
        }
    });

    function login() {
        const email = document.getElementById('emailInput').value;
        const pass = document.getElementById('passInput').value;
        auth.signInWithEmailAndPassword(email, pass).catch(e => document.getElementById('loginError').textContent = e.message);
    }
    function logout() { auth.signOut(); }

    // ==========================================
    // --- MOTOR DEL JUEGO (CANVAS) ---
    // ==========================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Ajustar canvas al ancho del contenedor
    function resizeCanvas() {
        const containerWidth = document.querySelector('.container').clientWidth - 40; // padding
        canvas.width = Math.min(400, containerWidth);
        canvas.height = 500;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Variables del Juego
    let gameRunning = false;
    let score = 0;
    let player = { x: canvas.width / 2 - 20, y: canvas.height - 60, w: 40, h: 40, color: '#22c55e', speed: 25 };
    let obstacles = [];
    let frameCount = 0;
    let obstacleSpeed = 3;

    // Controles de Teclado
    document.addEventListener('keydown', (e) => {
        if (!gameRunning) return;
        if (e.key === 'ArrowLeft') moveLeft();
        if (e.key === 'ArrowRight') moveRight();
    });

    // Controles T치ctiles (Toque en el canvas)
    canvas.addEventListener('touchstart', handleTouch, {passive: false});
    canvas.addEventListener('mousedown', handleTouch);

    function handleTouch(e) {
        if (!gameRunning) return;
        e.preventDefault(); // Evitar scroll
        
        // Obtener posici칩n del toque/click
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const x = clientX - rect.left;

        if (x < canvas.width / 2) moveLeft();
        else moveRight();
    }

    function moveLeft() {
        player.x -= player.speed;
        if (player.x < 0) player.x = 0;
    }

    function moveRight() {
        player.x += player.speed;
        if (player.x + player.w > canvas.width) player.x = canvas.width - player.w;
    }

    function startGame() {
        // Reset variables
        player.x = canvas.width / 2 - 20;
        obstacles = [];
        score = 0;
        frameCount = 0;
        obstacleSpeed = 3;
        gameRunning = true;

        // UI
        document.getElementById('startScreen').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        
        // Loop
        requestAnimationFrame(gameLoop);
    }

    function gameLoop() {
        if (!gameRunning) return;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Dibujar Jugador (Cuadrado Verde)
        ctx.fillStyle = player.color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = player.color;
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.shadowBlur = 0;

        // 2. Generar Obst치culos
        frameCount++;
        // Cada 60 frames (aprox 1 seg) o menos si va r치pido
        if (frameCount % Math.max(20, 60 - Math.floor(score/5)) === 0) {
            const size = Math.random() * 30 + 30; // Ancho variable
            const xPos = Math.random() * (canvas.width - size);
            obstacles.push({ x: xPos, y: -50, w: size, h: 20, color: '#ef4444' });
        }

        // 3. Mover y Dibujar Obst치culos
        for (let i = 0; i < obstacles.length; i++) {
            let obs = obstacles[i];
            obs.y += obstacleSpeed;

            // Dibujar
            ctx.fillStyle = obs.color;
            ctx.fillRect(obs.x, obs.y, obs.w, obs.h);

            // Colisi칩n
            if (
                player.x < obs.x + obs.w &&
                player.x + player.w > obs.x &&
                player.y < obs.y + obs.h &&
                player.h + player.y > obs.y
            ) {
                gameOver();
                return;
            }

            // Puntaje (si sale de pantalla)
            if (obs.y > canvas.height) {
                obstacles.splice(i, 1);
                i--;
                score++;
                
                // Aumentar dificultad
                if (score % 5 === 0) obstacleSpeed += 0.2;
            }
        }

        // Dibujar Puntaje actual
        ctx.fillStyle = "white";
        ctx.font = "20px Arial";
        ctx.fillText("Puntos: " + score, 10, 30);

        requestAnimationFrame(gameLoop);
    }

    function gameOver() {
        gameRunning = false;
        document.getElementById('gameOverScreen').classList.remove('hidden');
        document.getElementById('finalScoreDisplay').textContent = score;
        
        // Guardar en Firebase
        saveScore(score);
    }

    // ==========================================
    // --- CONEXI칍N CON LA NUBE (FIREBASE) ---
    // ==========================================

    function saveScore(points) {
        const user = auth.currentUser;
        if (!user) return;

        const userName = user.email.split('@')[0];

        // Guardamos en 'arcadeScores'
        db.ref('arcadeScores').push({
            player: userName,
            score: points,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // LEADERBOARD: Obtener los puntajes m치s altos
    // Firebase ordena ascendente, as칤 que pedimos los 칰ltimos (Last) que son los mayores
    db.ref('arcadeScores').orderByChild('score').limitToLast(10).on('value', (snapshot) => {
        const tableBody = document.getElementById('leaderboardTable');
        tableBody.innerHTML = '';
        
        let scores = [];
        snapshot.forEach((child) => {
            scores.push(child.val());
        });

        // Invertimos el array porque Firebase los da de menor a mayor, y queremos Mayor a Menor
        scores.reverse();

        if (scores.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Sin records a칰n</td></tr>';
            return;
        }

        scores.forEach((data, index) => {
            const row = tableBody.insertRow();
            
            // Colores para 1, 2, 3
            let rankClass = '';
            if (index === 0) rankClass = 'rank-1';
            if (index === 1) rankClass = 'rank-2';
            if (index === 2) rankClass = 'rank-3';

            // Medalla
            let icon = index === 0 ? '游녬 ' : (index < 3 ? '游끤 ' : '');

            row.innerHTML = `
                <td class="${rankClass}"><b>${index + 1}</b></td>
                <td>${icon}${data.player}</td>
                <td><b>${data.score}</b></td>
            `;
        });
    });

</script>
</body>
</html>
